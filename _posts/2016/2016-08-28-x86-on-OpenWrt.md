---
layout: post
title:  "X86 Router on OpenWRT"
date:   2016-8-28 14:20:33
---
## 目的
- NAS
- 软路由

## 设备列表
- 板子特征：支持IPMI、VT-D，CPU可以用Xeon L3406，这U性能羸弱，但功耗低，NAS+软路由足够了，而且白菜价（30￥）。缺点在于内存要纯ECC的。
- SSD 1块，2块机械硬盘
- 联想Think centreM90/M70E M-ATX小机箱。市面上这种支持M-ATX的小机箱基本没有，银欣有几款HTPC，还是有大了点。现在机箱都是瞄准游戏玩家，或者是ITX这种小钢炮型的。想想机箱发展这么多年，能够选择的类型并不多。

## 安装
主板要升级下BMC，不然运行IPMC Console有些小问题。

除了内存比较特别，散热器也是，规格要对，而且固定螺柱要分开，不然容易碰到主板的电容。内存如果安装不正确，机器能开机，但是没有任何输出，也没有警报。

## 软件配置
OpenWrt作为Ubuntu Server上面的一个KVM虚拟机运行。直接从官网下载镜像，在virt-manager里面运行。如果遇到`waiting for root device /dev/sda2...`的错误，把磁盘类型从virtio改变成IDE或者SATA，这个可能是OpenWrt没有加上特定驱动的原因。

OpenWrt至少需要两个NIC，因为主板和CPU支持VT-D，可以直接把PCI设备赋给虚拟机。新点的设备比如Intel 82575/82576要`igb`驱动，这个OpenWrt默认没有编译到里面去。要么自己编译一个，要么先赋给OpenWrt两个虚拟的NIC，比如`e1000`，然后OpenWrt通过DHCP连上网后，手工运行`opkg install kmod-igb`安装需要的驱动。

这个台机器上还有两块机械硬盘划分给Ubuntu组成NAS。如果硬盘多，可以加上一块硬盘阵列卡，划分给一个freenas/freebsd虚拟机。

## 总结
这种配置还是过于庞大，我还是喜欢路由器大小的设备，上面还有交换机芯片和5网口，配置VLAN很方便。但是一般的MIPS的太慢，ARM双核的又集成了我并不需要的双频导致价格很贵。市面上并没有这种专门为IO优化的有线路由器。

<img src="/images/2016/x86-router.png">
<img src="/images/2016/x86-router-box.jpg">
<img src="/images/2016/x86-router-back.jpg">
<img src="/images/2016/x86-router-box2.jpg">
