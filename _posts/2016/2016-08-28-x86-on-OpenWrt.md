---
layout: post
title:  "X86 Router on OpenWRT"
date:   2016-8-28 14:20:33
---
an example on router on Atom CPU
https://www.flickr.com/photos/alexatkinuk/8562831257/in/set-72157633066236442 

Openwrt
Install OpenWrt on VM.
For x86, After I download from here and run it by virt manager, stop at:
     waiting for root device /dev/sda2...
To fix it, change hd type from virtio to IDE. SATA also ok.
To support i350 network, run "make kernel_menuconfig" and add "Intel(R) 82575/82576 PCI-Express Gigabit Ethernet support". It will be compiled as "igb" module(or install by luci?). Then demsg will say `igb 000:00: added PHC on eth0`.
If want to connect host network, add 2 Virtual Network Interface with model "virtio". One is LAN. One is WAN and get virtual IP from host.

Another way: use official firmware, add 2 e1000 virtual NIC to connect network at first, then install PCI-E NIC driver: `opkg install kmod-igb`.

Stop /etc/init.d/firewall then I can access LUCI even I am not a DHCP client of router.

Run `virsh reboot openwrt`. It can't reboot vm. Need ssh to vm and run "reboot". So the openwrt can't get reboot PC ACPI message?

igb driver looks support VLAN.
http://downloadmirror.intel.com/23093/eng/README.txt
http://docs.oracle.com/cd/E25539_01/html/E25540/z40001c91004534.html 
http://wiki.openwrt.org/doc/uci/network/switch#example_vmware_linux_guest_openwrt_x86_generic_1209_combined_2virtualized_intel_e1000 
Can I assign the i350 as one device and use “switch” in Openwrt? so how to disable pci-stub in host machine? I directly disabled pci-stub module and lspci still show many pci device.

I have to use openwrt-x86-kvm_guest-combined-ext4.img. Now I found I can use openwrt-x86-64-combined-ext4.img, and I have to choose SATA as disk otherwise boot process will stop at “waiting for root device”.

Openwrt on Athlon sometimes became offline. Have to reboot guest to connect internet again. host dmesg has log:
```
     [80326.666258] perf samples too long (2505 > 2500), lowering kernel.perf_event_max_sample_rate to 50000
     openwrt has log:
       506.486069] nf_conntrack: automatic helper assignment is deprecated and it will be removed soon. Use the iptables CT target to attach helpers instead.
     [104843.170483] igb 0000:00:03.0 eth0: igb: eth0 NIC Link is Down
     [104843.190101] igb 0000:00:03.0 eth0: Reset adapter
     [104847.070726] igb 0000:00:03.0 eth0: igb: eth0 NIC Link is Up 1000 Mbps Full Duplex, Flow Control: RX
     [104848.184560] BUG: unable to handle kernel NULL pointer dereference at 000002c4
     [104848.190269] IP: [<d0d9c1a1>] 0xd0d9c1a1
     [104848.190269] *pdpt = 0000000000000000 *pde = f000ff53f000ff53
     [104848.190269] Oops: 0000 [#1] SMP
     [104848.190269] Modules linked in: pppoe ppp_async iptable_nat pppox ppp_generic nf_nat_ipv4 nf_conntrack_ipv6 nf_conntrack_ipv4 ipt_REJECT ipt_MASQUERADE xt_time xt_tcpudp xt_state xt_nat xt_multiport xt_mark xt_mac xt_limit xt_id xt_conntrack xt_comment xt_TCPMSS xt_REDIRECT xt_LOG xt_CT slhc nf_reject_ipv4 nf_nat_masquerade_ipv4 nf_nat_ftp nf_nat nf_log_ipv4 nf_defrag_ipv6 nf_defrag_ipv4 nf_conntrack_rtcache nf_conntrack_ftp nf_conntrack iptable_raw iptable_mangle iptable_filter ip_tables crc_ccitt evdev virtio_net ip6t_REJECT nf_reject_ipv6 nf_log_ipv6 nf_log_common ip6table_raw ip6table_mangle ip6table_filter ip6_tables x_tables ipv6 virtio_rng virtio_balloon button_hotplug
     [104848.190269] CPU: 0 PID: 1282 Comm: pppd Not tainted 3.18.20 #3
     [104848.190269] task: cfb23b80 ti: cecd6000 task.ti: cecd6000
     [104848.190269] EIP: 0060:[<d0d9c1a1>] EFLAGS: 00010202 CPU: 0
     [104848.190269] EIP is at 0xd0d9c1a1
     [104848.190269] EAX: 00000000 EBX: cf1e1800 ECX: cf1e1854 EDX: fffffe01
     [104848.190269] ESI: d0d9c600 EDI: cf4c3300 EBP: cf806d90 ESP: cecd7ddc
     [104848.190269]  DS: 007b ES: 007b FS: 00d8 GS: 00e0 SS: 0068
     [104848.190269] CR0: 80050033 CR2: 000002c4 CR3: 0146e000 CR4: 000406f0
     [104848.190269] Stack:
     [104848.190269]  00000000 cf4c331c 00000008 cf4c3300 d0d9c600 cf4c331c cf806d90 c12719ad
     [104848.190269]  00000000 cf956e40 cf956e40 00000008 c1271a10 c10b9b97 00000001 00000000
     [104848.190269]  00000000 cf4d4b00 cf956e48 cf0d1e40 cfb23f18 cfb23b80 c147a6c8 c1048194
     [104848.190269] Call Trace:
     [104848.190269]  [<c12719ad>] ? sock_release+0x14/0x6f
     [104848.190269]  [<c1271a10>] ? sock_close+0x8/0xb
     [104848.190269]  [<c10b9b97>] ? __fput+0xc2/0x173
     [104848.190269]  [<c1048194>] ? task_work_run+0x62/0x7e
     [104848.190269]  [<c1036aa0>] ? do_exit+0x2b6/0x752
     [104848.190269]  [<c103d4cb>] ? __dequeue_signal+0xd/0x119
     [104848.190269]  [<c103d142>] ? recalc_sigpending+0xb/0x1e
     [104848.190269]  [<c1037c3e>] ? do_group_exit+0x93/0xe6
     [104848.190269]  [<c103f621>] ? get_signal+0x589/0x717
     [104848.190269]  [<c10017c6>] ? do_signal+0x15/0x78f
     [104848.190269]  [<c12783df>] ? skb_dequeue+0x41/0x47
     [104848.190269]  [<c102d7c4>] ? pvclock_clocksource_read+0xc2/0xf6
     [104848.190269]  [<c102ce76>] ? kvm_clock_get_cycles+0x17/0x19
     [104848.190269]  [<c106b9cc>] ? ktime_get_ts64+0x4f/0x10e
     [104848.190269]  [<c10c689b>] ? poll_select_copy_remaining+0xda/0x106
     [104848.190269]  [<c10c7344>] ? SyS_select+0xbc/0xc8
     [104848.190269]  [<c1001f5c>] ? do_notify_resume+0x1c/0x49
     [104848.190269]  [<c1301aa1>] ? work_notifysig+0x2c/0x33
     [104848.190269] Code: 4d f0 8b 83 ac 00 00 00 a8 01 74 11 89 d8 e8 16 83 4d f0 b8 f7 ff ff ff e9 e7 00 00 00 0f b6 43 12 a8 0b 74 19 8b 83 dc 01 00 00 <8b> 80 c4 02 00 00 64 ff 08 c7 83 dc 01 00 00 00 00 00 00 89 d8
     [104848.190269] EIP: [<d0d9c1a1>] 0xd0d9c1a1 SS:ESP 0068:cecd7ddc
     [104848.190269] CR2: 00000000000002c4
     [104848.190269] ---[ end trace 41538ac2afb3f4aa ]---
     [104848.190269] Fixing recursive fault but reboot is needed!
     [104848.747164] 8021q: adding VLAN 0 to HW filter on device eth0
     [104848.759475] IPv6: ADDRCONF(NETDEV_UP): eth0: link is not ready
     [104852.945720] igb 0000:00:03.0 eth0: igb: eth0 NIC Link is Up 1000 Mbps Full Duplex, Flow Control: RX
     [104852.966832] IPv6: ADDRCONF(NETDEV_CHANGE): eth0: link becomes ready
     [104853.810476] igb 0000:00:03.0 eth0: igb: eth0 NIC Link is Down
     [104856.850517] igb 0000:00:03.0 eth0: igb: eth0 NIC Link is Up 1000 Mbps Full Duplex, Flow Control: RX
     [104859.047164] 8021q: adding VLAN 0 to HW filter on device eth0
     [104859.053223] IPv6: ADDRCONF(NETDEV_UP): eth0: link is not ready
```
It is because of cheap Intel i350? Or AMD chipset?

Use firmware I compiled on snapshot src, by onboard Intel 82573 NIC, get error:
```
     [  120.963370] IPv6: ADDRCONF(NETDEV_UP): eth0: link is not ready
     [  120.975845] 8021q: adding VLAN 0 to HW filter on device eth0
     [  123.103376] e1000e: eth0 NIC Link is Up 100 Mbps Full Duplex, Flow Control: Rx/Tx
     [  123.115747] e1000e 0000:00:03.0 eth0: 10/100 speed: disabling TSO
     [  123.124032] IPv6: ADDRCONF(NETDEV_CHANGE): eth0: link becomes ready
     [  123.226536] e1000e: eth0 NIC Link is Down
```
But ok with official 15.05.1 firmware.

Sun Aug 14 03:11:03 2016 daemon.err pppd[5665]: Please load the ppp_generic kernel module.
kernel_menuconfig -> Networking device support -> PPP support
Failed to create PPPoE socket: Address family not supported by protocol ->kernel_menuconfig -> Networking device support -> PPP support-> PPPOE over ethernet
Oh, shit. Turn to official 15.05.1 firmware!

So it support hardware VLAN?
```
     [    7.499718] e1000e: Intel(R) PRO/1000 Network Driver - 2.3.2-k
     [    7.506292] e1000e: Copyright(c) 1999 - 2014 Intel Corporation.
     [    7.518594] e1000e 0000:00:03.0: Interrupt Throttling Rate (ints/sec) set to dynamic conservative mode
     [    7.530302] e1000e 0000:00:03.0: irq 27 for MSI/MSI-X
     [    7.530323] e1000e 0000:00:03.0: irq 28 for MSI/MSI-X
     [    7.530343] e1000e 0000:00:03.0: irq 29 for MSI/MSI-X
     [    7.654170] e1000e 0000:00:03.0 eth0: registered PHC clock
     [    7.664555] e1000e 0000:00:03.0 eth0: (PCI Express:2.5GT/s:Width x1) 00:25:90:62:72:fa
     [    7.676476] e1000e 0000:00:03.0 eth0: Intel(R) PRO/1000 Network Connection
     [    7.684256] e1000e 0000:00:03.0 eth0: MAC: 3, PHY: 8, PBA No: 0101FF-0FF
     [    7.694944] e1000e 0000:00:09.0: Interrupt Throttling Rate (ints/sec) set to dynamic conservative mode
     [    7.708656] e1000e 0000:00:09.0: irq 30 for MSI/MSI-X
     [    7.708677] e1000e 0000:00:09.0: irq 31 for MSI/MSI-X
     [    7.708697] e1000e 0000:00:09.0: irq 32 for MSI/MSI-X
     [    7.826349] e1000e 0000:00:09.0 eth1: registered PHC clock
     [    7.834641] e1000e 0000:00:09.0 eth1: (PCI Express:2.5GT/s:Width x1) 00:25:90:62:72:fb
     [    7.845003] e1000e 0000:00:09.0 eth1: Intel(R) PRO/1000 Network Connection
     [    7.855383] e1000e 0000:00:09.0 eth1: MAC: 3, PHY: 8, PBA No: 0101FF-0FF
     [    7.863602] ip_tables: (C) 2000-2006 Netfilter Core Team
     [    7.870540] nf_conntrack version 0.5.0 (1959 buckets, 7836 max)
     [    7.880405] xt_time: kernel timezone is -0000
     [    7.888427] PPP generic driver version 2.4.2
     [    7.896658] NET: Registered protocol family 24
     [    9.181013] 8021q: adding VLAN 0 to HW filter on device eth0
     [    9.189825] device eth0 entered promiscuous mode
     [    9.197027] IPv6: ADDRCONF(NETDEV_UP): br-lan: link is not ready
     [    9.291134] 8021q: adding VLAN 0 to HW filter on device eth1
     [    9.297825] IPv6: ADDRCONF(NETDEV_UP): eth1: link is not ready
     [   11.611150] e1000e: eth1 NIC Link is Up 1000 Mbps Full Duplex, Flow Control: Rx/Tx
     [   11.626476] IPv6: ADDRCONF(NETDEV_CHANGE): eth1: link becomes ready
     [   12.171143] e1000e: eth0 NIC Link is Up 1000 Mbps Full Duplex, Flow Control: Rx/Tx
     [   12.182103] br-lan: port 1(eth0) entered forwarding state
     [   12.187330] br-lan: port 1(eth0) entered forwarding state
     [   12.193455] IPv6: ADDRCONF(NETDEV_CHANGE): br-lan: link becomes ready
     [   14.180119] br-lan: port 1(eth0) entered forwarding state
     [   16.663299] pppoe-wan: renamed from ppp0
     [   28.644496] random: nonblocking pool is initialized
```
http://lxr.free-electrons.com/source/net/8021q/vlan.c .So the NIC support hardware VLAN tag? http://www.stlinux.com/howto/network/short-guide

<img src="/images/2016/x86-router.png">
板子特征：支持IPMI，CPU可以用Xeon L3406，这U性能羸弱，但功耗低，NAS+软路由足够了，而且白菜价。缺点在于内存要纯ECC的。
